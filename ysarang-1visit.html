<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>의사랑 주사 1회 상세 분석</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --thead:#f3f4f6; --hover:#f9fafb; --group:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR',Arial,sans-serif;}
    header{padding:24px 16px 0; text-align:center;}
    h1{margin:0 0 6px; font-size:24px; font-weight:800; color:#0f172a}
    p.sub{margin:0; color:var(--muted); font-size:13px}
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-top:12px}
    .card-title{margin:0 0 8px; font-weight:700; color:#111827}
    .grid{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr 1fr}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=file]{width:100%; padding:10px; border-radius:10px; border:1px dashed var(--border); background:#fff; color:var(--text)}
    button{height:38px; border-radius:10px; border:1px solid var(--border);
      background:radial-gradient(120% 120% at 0% 0%,rgba(34,211,238,.25),rgba(34,211,238,.1));
      color:#0f172a; font-weight:700; cursor:pointer; padding:0 12px;}
    button:disabled{opacity:.5; cursor:not-allowed}
    .right{display:flex; gap:8px; justify-content:flex-end}

    .table-card{overflow:auto; margin-top:10px}
    table{width:100%; border-collapse:collapse; table-layout:fixed;
      background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; word-break:keep-all; white-space:normal; font-size:12px;}
    th{position:sticky; top:0; background:var(--thead); z-index:1; color:#0f172a}
    tbody tr:hover td{background:var(--hover)}

    header .logo{
      width:170px; max-width:70vw; height:auto; display:block; margin:0 auto 10px;
      filter: grayscale(1) saturate(0) brightness(.45) contrast(1.15);
    }
    .wm{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:0;
    }
    .wm img{
      width:min(760px, 78vw); opacity:.075; user-select:none;
      filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05);
    }
    body > *{ position:relative; z-index:1; }
    table, .table-card, .card{ background: rgba(255,255,255,.10) !important; }
    
    .blue-text{ color:#0ea5e9; font-weight:700 }
  </style>
</head>
<body>
  <div class="wm" aria-hidden="true"><img src="jinsul-logo.png" alt=""></div>
  <header>
    <img src="jinsul-logo.png" alt="JINSUL" class="logo" />
    <h1>의사랑 주사 1회 상세 분석</h1>
    <p class="sub">진료실별 초진 환자 중 기간 내 주사 처방이 1회인 환자 상세 정보</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div><label>초진 파일(진료실별)</label><input type="file" id="clinicFiles" multiple accept=".xlsx,.xls,.csv" /></div>
        <div><label>주사 파일</label><input type="file" id="bFile" accept=".xlsx,.xls,.csv" /></div>
        <div><label>총 환자(초진+재진)</label><input type="file" id="vFile" accept=".xlsx,.xls,.csv" /></div>
        <div><label>연락처 파일(휴대전화.xls)</label><input type="file" id="contactFile" accept=".xlsx,.xls,.csv" /></div>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="runBtn">상세 리스트 추출</button>
        <button id="downloadBtn" disabled style="background:#fff">결과 다운로드(.xlsx)</button>
        <button id="clearBtn" style="background:#fff">초기화</button>
      </div>
    </div>

    <div class="card table-card">
      <h3 class="card-title">주사 1회 내원자 상세 목록 <span id="resCount" style="font-size:12px; color:var(--muted); font-weight:normal;"></span></h3>
      <div id="output"></div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    let finalResult = [];

    function excelDateToISO(v) {
      if (!v) return '';
      if (typeof v === 'number') {
        const d = new Date(Math.round((v - 25569) * 86400 * 1000));
        return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
      }
      const s = String(v).trim();
      return s.length === 8 && /^\d{8}$/.test(s) ? `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}` : s;
    }

    /**
     * 휴대폰 번호 정규화 보강: 0 생략 보정 및 000-0000-0000 포맷 강제
     */
    function normalizePhone(raw) {
      if (!raw) return '-';
      let d = String(raw).replace(/\D+/g,''); // 숫자만 남기기
      
      if (!d) return '-';

      // 엑셀에서 앞자리 0이 생략되어 10...으로 시작하는 경우 복원
      if (d.startsWith('10') && (d.length === 9 || d.length === 10)) {
        d = '0' + d;
      }

      // 11자리(010-1234-5678) 또는 10자리(010-123-4567) 포맷팅
      if (d.length === 11) {
        return d.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
      } else if (d.length === 10) {
        return d.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
      }
      
      return d;
    }

    async function readSheet(file){
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type:'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
    }

    function parseGrid(rows) {
      const cleanTxt = (s) => String(s || "").replace(/[\uFEFF\u200B\s]/g, "").toLowerCase();
      const hi = rows.findIndex(r => r.some(c => cleanTxt(c) === '차트번호' || cleanTxt(c) === '성명' || cleanTxt(c) === '휴대전화'));
      const idx = hi === -1 ? 0 : hi;
      return {
        headers: rows[idx].map(h => cleanTxt(h)),
        body: rows.slice(idx + 1)
      };
    }

    async function run() {
      const clinicFiles = $('#clinicFiles').files;
      const bFile = $('#bFile').files[0], vFile = $('#vFile').files[0], cFile = $('#contactFile').files[0];
      if (!clinicFiles.length || !bFile || !vFile) return alert('필수 파일들을 업로드해주세요.');
      
      $('#runBtn').disabled = true; $('#runBtn').textContent = '분석 중...';

      try {
        const bGrid = parseGrid(await readSheet(bFile)), vGrid = parseGrid(await readSheet(vFile));
        const bMap = {}, vMap = {};
        
        const bIdX = bGrid.headers.indexOf('차트번호');
        const bDtX = bGrid.headers.findIndex(h => /일자|내원일|진료일/.test(h));
        bGrid.body.forEach(r => {
          const id = String(r[bIdX] || "").trim();
          if (!id || id === '차트번호') return;
          const d = excelDateToISO(r[bDtX]);
          if(id && d) (bMap[id] ??= new Set()).add(d);
        });

        const vIdX = vGrid.headers.indexOf('차트번호');
        const vDtX = vGrid.headers.findIndex(h => /일자|내원일|진료일/.test(h));
        vGrid.body.forEach(r => {
          const id = String(r[vIdX] || "").trim();
          if (!id || id === '차트번호') return;
          const d = excelDateToISO(r[vDtX]);
          if(id && d) (vMap[id] ??= new Set()).add(d);
        });

        let contactMap = {}; 
        if (cFile) {
          const cGrid = parseGrid(await readSheet(cFile));
          const cIdX = cGrid.headers.indexOf('차트번호');
          const cPhX = cGrid.headers.indexOf('휴대전화');
          const cNmX = cGrid.headers.indexOf('성명');
          
          cGrid.body.forEach(r => {
            const id = String(r[cIdX] || "").trim();
            if (!id || id === '차트번호') return;
            const ph = normalizePhone(r[cPhX]); // 정규화 적용
            const name = String(r[cNmX] || "").trim();
            if (id) contactMap[id] = { ph, name };
          });
        }

        const result = [];
        for (const f of clinicFiles) {
          const grid = parseGrid(await readSheet(f));
          const idX = grid.headers.indexOf('차트번호');
          const nmX = grid.headers.findIndex(h => /성명|환자|수진자/.test(h));
          
          grid.body.forEach(r => {
            const id = String(r[idX] || "").trim();
            if (!id || id === '차트번호') return;
            
            if (id && bMap[id] && bMap[id].size === 1) {
              const allV = Array.from(vMap[id] || []).sort();
              const finalName = (contactMap[id] && contactMap[id].name) ? contactMap[id].name : String(r[nmX] || "").trim();
              const finalPhone = (contactMap[id] && contactMap[id].ph) ? contactMap[id].ph : "-";

              result.push({ 
                '차트번호': id, 
                '환자명': finalName || "-", 
                '휴대폰': finalPhone, 
                '최초 내원일': allV[0] || '-', 
                '주사 내원일': Array.from(bMap[id])[0], 
                '최종 내원일': allV[allV.length - 1] || '-', 
                '총 내원횟수': allV.length, 
                '진료실': f.name.split('.')[0] 
              });
            }
          });
        }

        finalResult = Array.from(new Map(result.map(i => [i['차트번호'], i])).values());
        
        // [수정됨] 최초 내원일 기준 오름차순 정렬 추가
        finalResult.sort((a, b) => {
          if (a['최초 내원일'] < b['최초 내원일']) return -1;
          if (a['최초 내원일'] > b['최초 내원일']) return 1;
          return 0;
        });

        renderResult(finalResult);
      } catch (e) {
        console.error(e);
        alert('분석 실패');
      } finally {
        $('#runBtn').disabled = false;
        $('#runBtn').textContent = '상세 리스트 추출';
      }
    }

    function renderResult(data) {
      if (!data.length) { $('#output').innerHTML = '<p style="text-align:center; padding:20px;">조건에 맞는 환자가 없습니다.</p>'; return; }
      $('#resCount').textContent = `(대상자: ${data.length}명)`; $('#downloadBtn').disabled = false;
      const cols = ['차트번호', '환자명', '휴대폰', '최초 내원일', '주사 내원일', '최종 내원일', '총 내원횟수', '진료실'];
      let h = '<table><thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>';
      data.forEach(r => {
        h += `<tr><td>${r['차트번호']}</td><td>${r['환자명']}</td><td>${r['휴대폰']}</td><td>${r['최초 내원일']}</td><td class="blue-text">${r['주사 내원일']}</td><td>${r['최종 내원일']}</td><td class="blue-text">${r['총 내원횟수']}</td><td>${r['진료실']}</td></tr>`;
      });
      $('#output').innerHTML = h + '</tbody></table>';
    }

    $('#runBtn').onclick = run;
    $('#clearBtn').onclick = () => location.reload();
    $('#downloadBtn').onclick = () => {
      const ws = XLSX.utils.json_to_sheet(finalResult);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "상세리스트");
      XLSX.writeFile(wb, `주사1회_상세리스트.xlsx`);
    };
  </script>
</body>
</html>