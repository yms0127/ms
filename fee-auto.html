<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JINSUL - Case Verification System (Set Search)</title>
    <style>
        /* [UI ìŠ¤íƒ€ì¼ ìœ ì§€] */
        :root { --primary: #333; --accent: #d73a49; --blue: #0052cc; --bg: #f6f6f7; --border: #ccc; }
        body { margin: 0; background-color: var(--bg); color: var(--primary); font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        input, select, button { font-family: inherit; } 
        .wm { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 0; }
        .wm img { width: min(760px, 78vw); opacity: .20; filter: grayscale(1) saturate(0) brightness(.65) contrast(1.05); }
        header { width: 100%; padding: 25px 0; text-align: center; position: relative; z-index: 1; }
        .top-logo { width: 170px; filter: grayscale(1) brightness(.45) contrast(1.15); opacity: 0.8; }
        #syncBoard { position: absolute; top: 10px; right: 20px; background: rgba(255,255,255,0.8); border: 1px solid #222; border-radius: 8px; padding: 12px 18px; font-size: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 240px; backdrop-filter: blur(5px); }
        #setBoard { position: absolute; top: 10px; left: 20px; background: rgba(255,255,255,0.8); border: 1px solid #222; border-radius: 8px; padding: 12px 18px; font-size: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 210px; backdrop-filter: blur(5px); }
        #setBoard select { width: 100%; margin-top: 6px; padding: 6px 8px; border-radius: 10px; border: 1px solid #ddd; font-weight: 700; font-size: 12px; background: rgba(255,255,255,0.9); }
        .sync-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .sync-row:last-child { margin-bottom: 0; }
        .sync-label { color: #555; font-weight: 700; }
        .sync-val { font-weight: 800; color: #333; }
        .ver-tag { font-size: 10px; color: #999; margin-left: 5px; font-weight: normal; }
        .container { width: 1550px; max-width: 98%; margin: 0 auto; display: grid; grid-template-columns: 1.75fr 1.25fr; gap: 25px; padding-bottom: 80px; position: relative; z-index: 1; flex: 1; }
        .card { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; padding: 25px; backdrop-filter: blur(2px); margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.02); }
        .section-title { font-size: 0.95em; font-weight: 800; color: #555; margin: 0 0 12px 0; border-left: 4px solid var(--primary); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--blue); }
        input:checked + .slider:before { transform: translateX(14px); }
        .consult-group { display: flex; gap: 8px; margin-bottom: 20px; }
        .c-btn { flex: 1; padding: 12px; border: 1px solid rgba(0,0,0,0.2); border-radius: 8px; background: rgba(255,255,255,0.4); cursor: pointer; font-weight: 800; font-size: 13px; color: #444; transition: 0.2s; }
        .c-btn:hover { background: rgba(255,255,255,0.6); }
        .c-btn.active { border-color: var(--primary); background: var(--primary); color: #fff; }
        
        /* ë ˆì´ì•„ì›ƒ ê³ ì • */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { padding: 8px 10px; text-align: left; font-size: 0.8em; color: #666; border-bottom: 2px solid rgba(0,0,0,0.1); background: transparent !important; white-space: nowrap; }
        td { padding: 6px 10px; background: transparent !important; font-size: 0.95em; font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.05); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th:nth-child(1) { width: 95px; } 
        th:nth-child(2) { width: auto; } 
        th:nth-child(3) { width: 80px; text-align:right; }
        th:nth-child(4) { width: 55px; text-align:center; }
        th:nth-child(5) { width: 60px; text-align:center; }
        th:nth-child(6) { width: 40px; text-align:center; }
        th:nth-child(7) { width: 40px; text-align:center; }
        
        .input-wrapper { position: relative; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; padding: 0 24px 0 8px; background: rgba(255,255,255,0.3); display: flex; align-items: center; height: 32px; transition: 0.2s; }
        .input-wrapper:focus-within { border-color: var(--blue); background: rgba(255,255,255,0.8); box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.1); }
        .input-wrapper::after { content: 'âœ'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #999; pointer-events: none; }
        .box-input { border: none; background: transparent !important; width: 100%; font-weight: 800; font-family: inherit; outline: none; font-size: 13px; color: #333; height: 100%; }
        .box-input-num { border: 1px solid rgba(0,0,0,0.25); border-radius: 4px; background: transparent !important; padding: 0 4px; height: 32px; font-weight: 800; outline: none; font-size: 13px; width: 100%; transition: 0.2s; color: #333; text-align: center; }
        .box-input-num:focus { border-color: var(--blue); background: rgba(255,255,255,0.2) !important; }
        .type-btn { border: 1px solid transparent; border-radius: 6px; padding: 0 10px; height: 28px; font-size: 11px; font-weight: 800; cursor: pointer; transition: 0.2s; width: 100%; text-align: center; }
        .type-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .type-b { background: #e3f2fd; color: #0052cc; border-color: #bbdefb; }
        .type-nb { background: #ffeef0; color: #d73a49; border-color: #ffcdd2; }
        .badge { display: inline-block; padding: 2px 6px; font-size: 10px; border-radius: 4px; font-weight: 900; margin-left: 6px; white-space: nowrap; letter-spacing: -0.5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .badge-req { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .badge-con { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .p-input { width: 100%; text-align: right; color: #333; }
        .q-input { width: 100%; text-align: center; color: var(--accent); }
        .diag-table { width: 100%; margin-bottom: 25px; }
        .diag-table td { padding: 8px 10px; background: transparent !important; border-bottom: 1px dashed rgba(0,0,0,0.1); color: #444; }
        .diag-code { font-weight: 800; color: var(--blue); }
        .set-selector-group { display: flex; gap: 10px; position: relative; }
        #setSel { flex: 1; background: rgba(255,255,255,0.3); border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; outline: none; cursor: pointer; font-weight: 800; font-size: 1.1em;  min-width:0;}
        #setSearchInput { width: 140px; border: 2px solid rgba(0,0,0,0.2); border-radius: 8px; padding: 0 12px; background: rgba(255,255,255,0.5); font-weight: 800; outline: none; font-size: 13px; }
        #setSearchInput:focus { border-color: var(--blue); background: #fff; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
        .summary-label { font-size: 13px; font-weight: 700; color: #666; }
        .summary-val { font-size: 16px; font-weight: 900; color: #333; }
        .target-input { font-size: 2.2em; width: 180px; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); text-align: right; font-weight: 900; outline: none; }
        #finalPay { font-size: 3.2em; font-weight: 900; color: var(--accent); letter-spacing: -2px; line-height: 1; }
        .matrix-container { display: grid; grid-template-columns: repeat(1, 1fr); gap: 6px; margin-top: 15px; }
        .matrix-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .matrix-row:hover { background: rgba(240, 247, 255, 0.6); border-color: var(--blue); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .matrix-target { font-weight: 800; color: #555; }
        .matrix-val { font-weight: 900; color: var(--blue); font-size: 13px; }
        .carry-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .carry-btn.active { opacity: 1; color: var(--blue); }
        .del-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; opacity: 1; color: #999; transition: 0.2s; } 
        .del-btn:hover { color: #d73a49; transform: scale(1.15); }
        .search-dropdown { position: absolute; background: rgba(255,255,255,0.98); z-index: 9999; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; width: 300px; }
        .search-item { padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        .search-item:hover { background: #f5f5f5; }
        .alert-box { padding: 12px 15px; border-radius: 8px; font-weight: 800; font-size: 13px; margin-bottom: 15px; display: none; border: 1px solid transparent; }
        .alert-red { background: rgba(255, 240, 241, 0.7); color: #d73a49; border-color: #d73a49; }
        .alert-orange { background: rgba(255, 248, 230, 0.7); color: #b7791f; border-color: #b7791f; }
        footer { width: 100%; text-align: center; padding: 50px 0; font-size: 12px; color: #888; background: transparent; font-weight: 600; }
        .inj-only-toggle{display:flex;align-items:center;gap:6px;padding:6px 10px;border:2px solid rgba(0,0,0,0.15);border-radius:10px;background:rgba(255,255,255,0.35);cursor:pointer;font-weight:900;font-size:12px;user-select:none;white-space:nowrap;min-width:74px;}
        .inj-only-toggle input{accent-color: var(--blue); width:14px; height:14px;}
        .select-line select, .select-line input {min-width:0;}
        .inj-only-toggle{flex:0 0 auto;}
        .block-adjust-row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 12px; background:rgba(255,255,255,0.2); border:1px solid rgba(0,0,0,0.12); border-radius:8px; margin-top:8px;}
        .block-adjust-label{font-size:12px; font-weight:900; color:#444; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .block-adjust-ctrl{display:flex; align-items:center; gap:8px; flex-shrink: 0;}
        .block-btn{width:34px; height:30px; border-radius:8px; border:2px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.5); font-weight:900; cursor:pointer; font-size:14px; line-height:1;}
        .block-btn:hover{border-color: var(--blue); box-shadow:0 2px 5px rgba(0,0,0,0.06); transform: translateY(-1px);}
        .block-step{width:70px; padding:6px 8px; border-radius:8px; border:2px solid rgba(0,0,0,0.18); background:rgba(255,255,255,0.55); font-weight:900; text-align:center;}
    </style>
</head>
<body onclick="closeSearch(event)">
<div class="wm"><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png"></div>
<div id="setBoard">
    <div class="sync-row"><span class="sync-label">ì²˜ë°©ì„¸íŠ¸</span><span id="setFileStatus" class="sync-val">-</span><span class="ver-tag">v0.0.0.7</span></div>
    <select id="setFileSel" onchange="changeSetFile()"><option value="">ë¡œë”©ì¤‘...</option></select>
</div>
<div id="syncBoard">
    <div class="sync-row"><span class="sync-label">ìˆ˜ê°€ ì ìš©ì¼ì</span><span id="st-date" class="sync-val">-</span></div>
    <div class="sync-row"><span class="sync-label">ë°ì´í„° ëˆ„ì ìˆ˜</span><span id="st-db" class="sync-val">...</span></div>
</div>
<header><img src="https://raw.githubusercontent.com/jinsul-lab/openteam/main/jinsul-logo.png" class="top-logo"></header>
<div class="container">
    <div class="main-column">
        <div class="card">
            <div class="section-title">ì§„ì°°ë£Œ ì‚°ì •</div>
            <div class="consult-group">
                <button onclick="setConsult('first')" id="btn-first" class="c-btn">ì´ˆì§„</button>
                <button onclick="setConsult('follow')" id="btn-follow" class="c-btn">ì¬ì§„</button>
                <button onclick="setConsult('none')" id="btn-none" class="c-btn active">ì‚°ì • ì•ˆí•¨</button>
            </div>
            <div class="section-title">ì½”ë“œ ì„ íƒ</div>
            <div class="set-selector-group">
                <select id="setSel" onchange="changeSet()"></select>
                <input type="text" id="setSearchInput" placeholder="ğŸ” ì„¸íŠ¸ ê²€ìƒ‰" oninput="searchSets(this.value, this)" onkeydown="if(event.key==='Escape') clearSearch()">
                <label class="inj-only-toggle" title="ì°¨ë‹¨ìˆ /ìˆ˜íŒ½/ê´€ì ˆì¡°ì˜ ë“± ì£¼ì‚¬ ì„¸íŠ¸ë§Œ í‘œì‹œ"><input type="checkbox" id="injOnlyToggle" onchange="toggleInjectionOnly()"> ì£¼ì‚¬ë§Œ</label>
            </div>
            <div id="dataView" style="display:none; margin-top:30px;">
                <div class="section-title"><span>í™˜ì ì¦ìƒ (C.C)</span><label class="switch"><input type="checkbox" id="ccSwitch" checked onchange="toggleCC()"><span class="slider"></span></label></div>
                <div id="ccContent" style="padding:15px; background:rgba(0,0,0,0.05); border-radius:8px; font-size:0.95em; line-height:1.6; margin-bottom:30px; border-left: 0px solid #999; min-height:20px; font-weight: 600;"></div>
                <div id="diagSection" style="display:none;"><div class="section-title" style="border-left-color: var(--blue); color:var(--blue); cursor: default;">ìƒë³‘ ë‚´ì—­</div><table class="diag-table"><thead><tr><th style="width:20%">ìƒë³‘ì½”ë“œ</th><th>ìƒë³‘ëª…ì¹­</th></tr></thead><tbody id="diagList"></tbody></table></div>
                <div class="section-title" style="cursor: default;">ì²˜ë°© ë‚´ì—­ / ë¹„ê¸‰ì—¬ ì¡°ì •</div>
                <div id="mainAlertBox" class="alert-box"></div>
                <table><thead><tr><th>ì²˜ë°©ì½”ë“œ</th><th>ì²˜ë°©ëª…ì¹­</th><th>ë‹¨ê°€</th><th>ìˆ˜ëŸ‰</th><th>êµ¬ë¶„</th><th>ìœ ì§€</th><th>ì‚­ì œ</th></tr></thead><tbody id="itemList"></tbody></table>
                <div style="margin-top:20px; display:flex; gap:10px; position:relative;" id="searchBox">
                    <input type="text" id="searchInput" placeholder="ëª…ì¹­ ë˜ëŠ” ì½”ë“œë¡œ ì²˜ë°© ê²€ìƒ‰" style="flex:1; padding:12px; border-radius:8px; border:2px solid rgba(0,0,0,0.2); font-weight:800; outline:none; font-size: 13px; background: rgba(255,255,255,0.3);" oninput="searchLive(this.value, 'main', this)" onkeydown="if(event.key==='Escape') clearSearch()">
                    <button onclick="addManualItem()" style="padding:0 20px; background:rgba(255,255,255,0.5); border:2px solid var(--primary); border-radius:8px; font-weight:800; cursor:pointer; font-size:12px;">+ ì„ì˜ ì¶”ê°€</button>
                </div>
                <button onclick="autoBalance()" style="background:var(--primary); color:white; width:100%; padding:18px; border:none; border-radius:10px; font-weight:900; margin-top:30px; cursor:pointer; font-size:1.05em; letter-spacing: 1px;">ê³„ì‚°</button>
            </div>
        </div>
    </div>
    <div class="side-column">
        <div class="card" style="background: rgba(255, 255, 255, 0.1); text-align: center; padding: 30px 20px;"><div style="font-size: 0.85em; color: #666; margin-bottom: 10px; font-weight: 800; letter-spacing: 1px;">ëª©í‘œê°€</div><div><input type="number" id="tAmt" class="target-input" value="89000" oninput="autoBalance()"> <span style="font-size: 1.2em; font-weight: 900;">ì›</span></div></div>
        <div class="card" style="border-top: 6px solid var(--primary);">
            <div class="summary-row"><span class="summary-label">ì´ ì§„ë£Œë¹„ í•©ê³„</span><span id="totalFull" class="summary-val">0</span></div>
            <div class="summary-row"><span class="summary-label">ê¸‰ì—¬ (ë³¸ì¸ë¶€ë‹´ 30%)</span><span id="summaryBenefit" class="summary-val">0</span></div>
            <div class="summary-row" style="border-bottom:none;"><span class="summary-label">ë¹„ê¸‰ì—¬ (100% ì „ì•¡)</span><span id="summaryNonBenefit" class="summary-val" style="color:var(--blue);">0</span></div>
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(0,0,0,0.1);"><div style="font-size: 12px; color: #777; font-weight: 800; margin-bottom: 8px;">ìµœì¢… ì‹¤ì œ ìˆ˜ë‚©ì•¡</div><div id="finalPay">0</div></div>
            <div id="blockAdjustWrap" style="margin-top:25px; text-align:left; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 20px;"></div>
            <div class="section-title" style="margin-top:40px; border-left-color: var(--blue);">ê¸ˆì•¡ë³„ ìˆ˜ëŸ‰ ì¡°ì •</div>
            <div id="matrixAdjustName" style="font-size:11px; color:var(--blue); font-weight:800; margin-bottom:10px; text-align:right;">-</div>
            <div id="matrixTable" class="matrix-container"></div>
        </div>
    </div>
</div>
<div id="globalSearchLayer" class="search-dropdown"></div>
<footer>Â© JINSUL Â· ê²½í—˜ê³¼ ê°€ì¹˜ë¥¼ í˜„ì‹¤í™”í•˜ëŠ” ì»¨ì„¤íŒ…</footer>
<script>
    const LOCAL_DATA = {}; 
    let DB = LOCAL_DATA;
    let flatDB = [];
    let carryOverItems = new Map();
    let currentCustomItems = []; 
    let deletedSetItems = new Set();
    const STRATEGY_DRUGS = ["ë¹„ì— íˆë£¨ë‹ˆë‹¤ì œ", "ë§ë¦°ë‹¤ì£¼", "ë¦¬í¬ë¼ì œì£¼"];
    const CONTRAST_REQUIRED_CODES = ["LA354", "LA359", "LA253", "LA355", "LA352", "HA280", "MM410"];
    const CONTRAST_KEYWORDS = ["OMNI", "VISI", "IOP", "HEX", "BONO", "CONTRAST", "ì˜´ë‹ˆ", "ìš¸íŠ¸ë¼", "ê°€ë„", "íŒŒë¯¸", "ë¹„ì§€", "ì´ì˜¤", "í—¥ì‚¬", "ë³´ë…¸", "ë„íƒ€", "ê²Œë„¤", "ì„¼ìŠ¤", "íŒŒí", "ìœ ë‹ˆ", "ë§ˆê·¸ë„¤", "í´ë¼ë¦¬"];
    let CONSULT_PRICES = { first: 0, follow: 0 };
    let currentConsult = "none";
    let activeInputEl = null;
    const fmt = n => Math.floor(n || 0).toLocaleString();
    const clean = n => parseFloat(String(n).replace(/,/g, '')) || 0;

    // [ë³µêµ¬] GitHub API ì›ë³µ (ì‚¬ìš©ì íŒŒì¼ ê¸°ë°˜)
    const GITHUB_OWNER = "jinsul-lab";
    const GITHUB_REPO = "openteam";
    const GITHUB_BRANCH = "main";
    const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;
    const API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/`;
    const unwrapData = (obj) => (obj && typeof obj === 'object' && obj.data && typeof obj.data === 'object') ? obj.data : obj;
    async function fetchJsonFromGithub(fileName) { const res = await fetch(RAW_BASE + fileName + "?t=" + Date.now()); if (!res.ok) throw new Error("fetch ì‹¤íŒ¨: " + fileName); return await res.json(); }
    async function listSetFiles() { try { const res = await fetch(API_BASE + "?ref=" + GITHUB_BRANCH); if (!res.ok) throw new Error("list ì‹¤íŒ¨"); const items = await res.json(); return (Array.isArray(items) ? items : []).filter(it => it && it.type === "file" && /^set.*\.json$/i.test(it.name)).map(it => it.name).sort((a,b) => a.localeCompare(b)); } catch(e) { console.warn("set*.json ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", e); return []; } }

    let INJ_ONLY = false;
    let SET_META = {};   
    const PART_ORDER = ["ê²½ì¶”","í‰ì¶”","ìš”ì¶”","ì–´ê¹¨","íŒ”ê¿ˆì¹˜","ì†ëª©/ì†","ê³¨ë°˜/ê³ ê´€ì ˆ","ëŒ€í‡´/ë¬´ë¦","ë°œëª©/ë°œ","ê¸°íƒ€"];
    function setFileDisplayName(f){ f=(f||"").toString(); if(f.toLowerCase()==="set_databaset.json"||f.toLowerCase()==="ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json")return "ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©"; const m=f.toLowerCase().match(/^set_([^\/]+)\.json$/i); if(m)return `${m[1]} ë¬¶ìŒì½”ë“œ`; return f; }
    function normalizeCodeForLookup(c){ c=(c||"").toString().trim().toUpperCase(); if(!c)return ""; const m=c.match(/^([A-Z]{1,3}\d{2,6})[A-Z_]+$/); return m?m[1]:c; }
    function fmt1(n){ const x=parseFloat(n); return isNaN(x)?"0.0":x.toFixed(1); }
    function detectMainTag(s){ const i=(s&&s.it)?s.it:[]; const a=i.map(x=>(x&&x.n?String(x.n):"")).join(" "); const c=i.map(x=>(x&&x.c?String(x.c):"")).join(" ").toUpperCase(); if(/ìˆ˜ì••íŒ½ì°½ìˆ |ìˆ˜ì••\s*íŒ½ì°½|hydrodilat/i.test(a))return "ìˆ˜íŒ½"; if(/\bHA280\b/.test(c)||/HA280/i.test(c))return "ì¡°ì˜"; return ""; }
    function sumBlockQty(s,p){ const i=(s&&s.it)?s.it:[]; let m=0; i.forEach(x=>{ const n=(x&&x.n!=null)?String(x.n):""; const c=(x&&x.c!=null)?String(x.c).toUpperCase():""; if(p.some(r=>(r instanceof RegExp)?(r.test(n)||r.test(c)):(n.includes(r)||c.includes(String(r).toUpperCase())))) m+=(parseFloat(x.q)||0); }); return m; }
    function inferSpineRegion(s){ const c=(s&&s.cc)?s.cc.join(" "):""; const n=((s&&s.it)?s.it.map(x=>String(x.n||"")).join(" "):""); let t=(c+" "+n).toUpperCase(); t=t.replace(/K\s*-\s*L\s*\d\s*(?:~|\-|TO)?\s*\d?/gi," ").replace(/K\s*-\s*L/gi," "); if(/\bC[\-\s]?\d/.test(t)||/CERV/i.test(t)||/ê²½ì¶”|ëª©/.test(t))return "C"; if(/\bT[\-\s]?\d/.test(t)||/THOR/i.test(t)||/í‰ì¶”|í‰/.test(t))return "T"; if(/\bL[\-\s]?\d/.test(t)||/LUMB/i.test(t)||/ìš”ì¶”|í—ˆë¦¬/.test(t))return "L"; if(/(EPI\b|EPIDURO)/i.test(t)&&/CERV/i.test(t))return "C"; if(/(EPI\b|EPIDURO)/i.test(t)&&/THOR/i.test(t))return "T"; if(/(EPI\b|EPIDURO)/i.test(t)&&/LUMB/i.test(t))return "L"; return ""; }
    function inferPeripheralPart(s){ const c=(s&&s.cc)?s.cc.join(" "):""; const n=((s&&s.it)?s.it.map(x=>String(x.n||"")).join(" "):""); const t=c+" "+n; if(/SCPB|\bCPB\b|SFCP|ê²½ì‹ ê²½ì´|CERVICAL\s*PLEX/i.test(t))return "ê²½ì¶”"; if(/ì–´ê¹¨|ê²¬ê´€ì ˆ|íšŒì „ê·¼|ê²¬ë´‰|ê²¬ê°‘|SSNB|ê²¬ê°‘ì‹ ê²½|ì•¡ì™€ì‹ ê²½|\bANB\b/i.test(t))return "ì–´ê¹¨"; if(/íŒ”ê¿ˆì¹˜|ì£¼ê´€ì ˆ|elbow/i.test(t))return "íŒ”ê¿ˆì¹˜"; if(/ì†ëª©|ìˆ˜ê·¼|ì†ê°€ë½|ì†\s*ì €ë¦¼|hand|wrist|\bAPNB\b|DIGITAL|MEDIAN|ULNAR|RADIAL/i.test(t))return "ì†ëª©/ì†"; if(/ê³ ê´€ì ˆ|hip|ì²œì¥ê´€ì ˆ|\bSIJ\b|ê³¨ë°˜/i.test(t))return "ê³¨ë°˜/ê³ ê´€ì ˆ"; if(/ë¬´ë¦|ìŠ¬ê´€ì ˆ|knee|ëŒ€í‡´|í—ˆë²…ì§€|\bFNB\b|ëŒ€í‡´ì‹ ê²½|\bLFCNB\b|ì™¸ì¸¡ëŒ€í‡´í”¼|\bSCNB\b|ì¢Œê³¨ì‹ ê²½/i.test(t))return "ëŒ€í‡´/ë¬´ë¦"; if(/ë°œëª©|ì¡±ê´€ì ˆ|ankle|ë°œ\b|foot|í•˜í‡´|ì¢…ì•„ë¦¬|\bSNB\b|SUR/i.test(t))return "ë°œëª©/ë°œ"; return "ê¸°íƒ€"; }
    function isInjectionSet(s){ const i=(s&&s.it)?s.it:[]; const a=i.map(x=>String(x.n||"")+" "+String(x.c||"")).join(" ").toUpperCase(); return /ì°¨ë‹¨|BLOCK|MBB|SNRB|PDNB|FJB|EPI|EPIDUR|SSNB|FNB|LFCNB|PCB|SCNB|ì•¡ì™€|ê´€ì ˆì¡°ì˜|HA280|ìˆ˜ì••íŒ½ì°½|HYDRODILAT/.test(a); }
    function buildBlocksLabel(s,p){ const r=[]; if(sumBlockQty(s,[/í›„ì§€ë‚´ì¸¡ì§€/i,/\bMBB\b/i])>0)r.push(`${p?p+"-":""}MBB ${fmt1(sumBlockQty(s,[/í›„ì§€ë‚´ì¸¡ì§€/i,/\bMBB\b/i]))}`); if(sumBlockQty(s,[/ì„ íƒê·¼ì‹ ê²½ê·¼/i,/\bSNRB\b/i])>0)r.push(`${p?p+"-":""}SNRB ${fmt1(sumBlockQty(s,[/ì„ íƒê·¼ì‹ ê²½ê·¼/i,/\bSNRB\b/i]))}`); if(sumBlockQty(s,[/ì¶”ê°„ê´€ì ˆ/i,/\bFJB\b/i])>0)r.push(`${p?p+"-":""}FJB ${fmt1(sumBlockQty(s,[/ì¶”ê°„ê´€ì ˆ/i,/\bFJB\b/i]))}`); if(sumBlockQty(s,[/ê²½ë§‰ì™¸|EPIDURO|EPI\b/i])>0)r.push(`${p?p+"-":""}EPI ${fmt1(sumBlockQty(s,[/ê²½ë§‰ì™¸|EPIDURO|EPI\b/i]))}`); if(sumBlockQty(s,[/ê²¬ê°‘ì‹ ê²½/i,/\bSSNB\b/i])>0)r.push(`SSNB ${fmt1(sumBlockQty(s,[/ê²¬ê°‘ì‹ ê²½/i,/\bSSNB\b/i]))}`); if(sumBlockQty(s,[/ëŒ€í‡´ì‹ ê²½/i,/\bFNB\b/i])>0)r.push(`FNB ${fmt1(sumBlockQty(s,[/ëŒ€í‡´ì‹ ê²½/i,/\bFNB\b/i]))}`); if(sumBlockQty(s,[/ì™¸ì¸¡ëŒ€í‡´í”¼/i,/\bLFCNB\b/i])>0)r.push(`LFCNB ${fmt1(sumBlockQty(s,[/ì™¸ì¸¡ëŒ€í‡´í”¼/i,/\bLFCNB\b/i]))}`); if(sumBlockQty(s,[/ìš”ì²œê³¨ì‹ ê²½ì´/i,/\bPCB\b/i])>0)r.push(`PCB ${fmt1(sumBlockQty(s,[/ìš”ì²œê³¨ì‹ ê²½ì´/i,/\bPCB\b/i]))}`); if(sumBlockQty(s,[/ì¢Œê³¨ì‹ ê²½/i,/\bSCNB\b/i])>0)r.push(`SCNB ${fmt1(sumBlockQty(s,[/ì¢Œê³¨ì‹ ê²½/i,/\bSCNB\b/i]))}`); if(sumBlockQty(s,[/ì•¡ì™€ì‹ ê²½ì°¨ë‹¨/i,/\bANB\b/i])>0)r.push(`ANB ${fmt1(sumBlockQty(s,[/ì•¡ì™€ì‹ ê²½ì°¨ë‹¨/i,/\bANB\b/i]))}`); if(sumBlockQty(s,[/ì•¡ì™€í•˜ë¶€|digital|median|ulnar|radial/i,/\bAPNB\b/i])>0)r.push(`APNB ${fmt1(sumBlockQty(s,[/ì•¡ì™€í•˜ë¶€|digital|median|ulnar|radial/i,/\bAPNB\b/i]))}`); if(sumBlockQty(s,[/ì²™ìˆ˜ì‹ ê²½í›„ì§€/i,/\bPDNB\b/i,/^LA357$/i])>0)r.push(`PDNB ${fmt1(sumBlockQty(s,[/ì²™ìˆ˜ì‹ ê²½í›„ì§€/i,/\bPDNB\b/i,/^LA357$/i]))}`); return r; }
    function extractTierFromNameOrMeta(s,f){ if(s){ const c=[s.tier,s.t,s.target,s.amt,s.price]; for(const v of c){ const n=parseFloat(v); if(!isNaN(n)&&n>=1&&n<100)return Math.round(n*10)/10; } let m=String(s.n||"").replace(/\+\s*0\.\d{3}\.\d{3}/g," ").replace(/0\.\d{3}\.\d{3}/g," "); const l=m.match(/\b\d{1,2}\.\d\b/g)||[]; for(const v of l){ const n=parseFloat(v); if(!isNaN(n)&&n>=1&&n<100)return Math.round(n*10)/10; } const k=m.match(/(\d{1,3}(?:,\d{3})+)\s*ì›/); if(k){ const w=parseInt(k[1].replace(/,/g,''),10); if(!isNaN(w)&&w>0)return Math.round((w/10000)*10)/10; } } if(f&&f>0)return Math.round((f/10000)*10)/10; return null; }
    function calcFinalPayForSet(s){ let b=0,n=0; if(currentConsult&&currentConsult!=="none") b+=CONSULT_PRICES[currentConsult]||0; const i=(s&&s.it)?s.it:[]; i.forEach(x=>{ const c=normalizeCodeForLookup((x&&x.c!=null)?String(x.c):""); const m=(x&&x.n!=null)?String(x.n):""; const q=parseFloat(x.q)||0; let info=DB.fee[c]||DB.drug[c]||DB.mat[c]; let p=info?info[1]:0; if(STRATEGY_DRUGS&&STRATEGY_DRUGS.some(d=>m.includes(d))) p=100000; if(!!(x.nb)||/SONO|C-ARM/i.test(c)) n+=(p*q); else b+=(p*q); }); const bp=Math.floor(Math.floor(b*0.3)/10)*10; return {bSum:b,nbSum:n,bPay:bp,finalPay:Math.floor((bp+n)/10)*10}; }
    function computeSetMeta(){ SET_META={}; if(!DB.sets)return; Object.keys(DB.sets).forEach(k=>{ let s=DB.sets[k]=normalizeSet(DB.sets[k]); const i=isInjectionSet(s), sp=inferSpineRegion(s), mt=detectMainTag(s); let p="ê¸°íƒ€"; const cq=sumBlockQty(s,[/í›„ì§€ë‚´ì¸¡ì§€/i,/\bMBB\b/i])+sumBlockQty(s,[/ì„ íƒê·¼ì‹ ê²½ê·¼/i,/\bSNRB\b/i])+sumBlockQty(s,[/ì¶”ê°„ê´€ì ˆ/i,/\bFJB\b/i])+sumBlockQty(s,[/ê²½ë§‰ì™¸|EPIDURO|\bEPI\b/i]); const pq=sumBlockQty(s,[/ì²™ìˆ˜ì‹ ê²½í›„ì§€/i,/\bPDNB\b/i]); const pp=inferPeripheralPart(s), sk=(x)=>(x==="C"?"ê²½ì¶”":(x==="T"?"í‰ì¶”":(x==="L"?"ìš”ì¶”":""))); if(i){ if(cq>0) p=sk(sp)||"ìš”ì¶”"; else if(pp&&pp!=="ê¸°íƒ€") p=pp; else if(pq>0) p=sk(sp)||"ìš”ì¶”"; else p=pp||"ê¸°íƒ€"; } else p=pp||"ê¸°íƒ€"; const bl=buildBlocksLabel(s,sp), cr=calcFinalPayForSet(s), tr=extractTierFromNameOrMeta(s,cr.finalPay); let l=`[${k}] ${s.n||""}`.replace(/\+\s*0\.\d{3}\.\d{3}/g,"").replace(/\s{2,}/g," ").trim(); const fl=(CURRENT_SET_FILE||"").toLowerCase(); if(fl==="set_databaset.json"||fl==="ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json"){ const rp=[]; if(mt)rp.push(mt); bl.forEach(b=>rp.push(b)); l=`[${p}] ${tr!=null?tr.toFixed(1):""}${rp.length?(" "+rp.join(" + ")):""}`.trim(); } if(!l||/^\[\s*\]/.test(l)){ l=((s&&s.n)?s.n:k)||""; l=String(l).replace(/\s{2,}/g," ").trim(); } const oi=PART_ORDER.indexOf(p), skey=(oi<0?999:oi).toString().padStart(3,"0")+"_"+k; SET_META[k]={label:l,search:(k+" "+(s.n||"")+" "+l+" "+p+" "+bl.join(" ")).toUpperCase(),part:p,sortKey:skey,isInj:i}; }); }
    function toggleInjectionOnly(){ INJ_ONLY=!!document.getElementById('injOnlyToggle')?.checked; refreshSetCodes(); const i=document.getElementById('setSearchInput'); if(i&&i.value)searchSets(i.value,i); }
    function refreshSetCodes(){ const s=document.getElementById('setSel'); if(!s)return; const pv=s.value; if(!DB.sets||Object.keys(DB.sets).length===0){ s.innerHTML='<option value="">-- ì²˜ë°© ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'; return; } computeSetMeta(); let k=Object.keys(DB.sets); if(INJ_ONLY) k=k.filter(x=>SET_META[x]&&SET_META[x].isInj); k.sort((a,b)=>(SET_META[a]?.sortKey||a).localeCompare(SET_META[b]?.sortKey||b)); const bp={}; k.forEach(x=>{ const p=SET_META[x]?.part||"ê¸°íƒ€"; (bp[p]||=[]).push(x); }); const o=PART_ORDER.filter(p=>bp[p]&&bp[p].length); let h='<option value="">-- ì²˜ë°© ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>'; o.forEach(p=>{ h+=`<option value="" disabled>â”€â”€ ${p} â”€â”€</option>`; bp[p].forEach(x=>{ h+=`<option value="${x}">${SET_META[x]?.label||""}</option>`; }); }); const r=k.filter(x=>!o.includes(SET_META[x]?.part||"ê¸°íƒ€")); if(r.length){ h+=`<option value="" disabled>â”€â”€ ê¸°íƒ€ â”€â”€</option>`; r.forEach(x=>{ h+=`<option value="${x}">${SET_META[x]?.label||""}</option>`; }); } s.innerHTML=h; if(pv&&DB.sets[pv])s.value=pv; }
    
    let CURRENT_SET_FILE = "";
    async function changeSetFile() { const s=document.getElementById('setFileSel'); const f=s?s.value:""; if(!f)return; try{ document.getElementById('setFileStatus').innerText="ë¡œë”©..."; const r=await fetchJsonFromGithub(f); const d=unwrapData(r); DB.sets=(d&&typeof d==='object')?d:{}; CURRENT_SET_FILE=f; document.getElementById('setFileStatus').innerText=setFileDisplayName(f)+` (${Object.keys(DB.sets).length}ê°œ)`; computeSetMeta(); refreshSetCodes(); document.getElementById('setSel').value=""; document.getElementById('dataView').style.display='none'; currentCustomItems=[]; deletedSetItems.clear(); document.getElementById('ccSwitch').checked=true; document.getElementById('ccContent').style.display='block'; }catch(e){ console.error(e); document.getElementById('setFileStatus').innerText="ë¡œë“œ ì‹¤íŒ¨"; DB.sets={}; refreshSetCodes(); } }
    function dbHasCode(c){ return !!((DB.fee&&DB.fee[c])||(DB.drug&&DB.drug[c])||(DB.mat&&DB.mat[c])); }
    function looksLikeCC(c,n){ c=(c||"").toString().trim(); n=(n||"").toString().trim(); if(!c&&!n)return true; if(/^\d+$/.test(c)&&c.length<=3)return true; if(/^\d+\.\s*/.test(n))return true; if(/^â–¼.*â–¼$/.test(n))return true; if(n.startsWith("*"))return true; if(n.endsWith(":"))return true; if(["PLAN","F/U","ê²½ê³¼ì¼","ë‹¤ìŒ ì£¼ì‚¬ì¼","ì£¼ê¸°ì¹˜ë£Œì‚¬"].some(h=>n.toUpperCase().includes(h)))return true; return false; }
    function looksLikeDiagnosis(c,n){ if(dbHasCode(c))return false; if(!/^[A-Z]{1,2}\d{2,5}$/.test(c))return false; n=(n||"").toString(); if(["ìˆ ","ê²€ì‚¬","ì´¬ì˜","ì´ˆìŒíŒŒ","ì£¼ì‚¬","ì°¨ë‹¨","ë„ìˆ˜","ë¬¼ë¦¬","ì¹˜ë£Œ","ì‹œìˆ ","í…Œì´í•‘","C-ARM","MRI","X-RAY","XRAY","Xray"].some(h=>n.includes(h)))return false; if(["ì£¼","mg","ml","g","tab","cap","ì •","ìº¡ìŠ","ì•°í”Œ","vial","ë°”ì´ì•Œ","ë¸Œë¦­ìŠ¤","io","block"].some(h=>n.toUpperCase().includes(h.toUpperCase())))return false; return true; }
    function normalizeSet(s){ if(!s||typeof s!=='object')return s; if(s.__normalized)return s; const cc=Array.isArray(s.cc)?[...s.cc]:[]; const dg=Array.isArray(s.dg)?[...s.dg]:[]; const it=[]; (s.it||[]).forEach(x=>{ const c=(x&&x.c!=null)?String(x.c).trim():""; const n=(x&&x.n!=null)?String(x.n).trim():""; const cu=c.toUpperCase(); if(/^\d+$/.test(c)&&n==="")return; if(looksLikeCC(c,n)){ if(n)cc.push(n); return; } if(looksLikeDiagnosis(cu,n)){ dg.push({c:c,n:n||c}); return; } it.push(x); }); return {...s,cc,dg,it,__normalized:true}; }
    
    async function init(){ try{ DB={fee:{},drug:{},mat:{},sets:{},dates:{}}; let d=null; 
        try{const f=await fetchJsonFromGithub("fee.json"); DB.fee=unwrapData(f);}catch(e){} 
        try{const dr=await fetchJsonFromGithub("drug.json"); DB.drug=unwrapData(dr);}catch(e){} 
        try{const m=await fetchJsonFromGithub("mat.json"); DB.mat=unwrapData(m);}catch(e){} 
        let overrideRaw = null;
        try{ overrideRaw = await fetchJsonFromGithub("override.json"); } catch(e) {}
        const overrideObj = overrideRaw ? unwrapData(overrideRaw) : null;
        const BUILTIN_OVERRIDE = { drug: {"LIDO2":["ë¦¬ë„ì¹´ì¸ì—¼ì‚° 20ml 2% (íœ´ì˜¨ìŠ¤)",649,"670603485"],"NS100":["ëŒ€í•œë©¸ê· ìƒë¦¬ì‹ì—¼ìˆ˜(0.9% 100mL)",1110,"645100562"],"DW100":["í¬ë„ë‹¹ì£¼ì‚¬ì•¡(5%) 100mL",1188,"645100973"]} };
        function applyOverrides(ov){ if(!ov) return; ["fee","drug","mat"].forEach(k=>{ if(ov[k]) Object.keys(ov[k]).forEach(c=>DB[k][c.toUpperCase()]=ov[k][c]); }); }
        applyOverrides(BUILTIN_OVERRIDE); applyOverrides(overrideObj);
        try{ 
            if(!DB.fee||Object.keys(DB.fee).length===0){
                const resAll = await fetch(RAW_BASE + "database.json?t=" + Date.now());
                if(resAll.ok){ const dbAll=await resAll.json(); if(dbAll){ if(dbAll.fee)DB.fee=dbAll.fee; if(dbAll.drug)DB.drug=dbAll.drug; if(dbAll.mat)DB.mat=dbAll.mat; if(dbAll.dates)d=dbAll.dates; }}
            }
        }catch(e){} 
        if(d)DB.dates=d; 
        document.getElementById('st-date').innerText=DB.dates?.fee||"-"; 
        const f1=getFeePrice('AA154')||17610; const f2=getFeePrice('AA254')||12590; CONSULT_PRICES={first:f1,follow:f2}; 
        document.getElementById('btn-first').innerText=`ì´ˆì§„ (${fmt(f1)})`; document.getElementById('btn-follow').innerText=`ì¬ì§„ (${fmt(f2)})`; 
        flatDB=[]; ["fee","drug","mat"].forEach(k=>{ if(DB[k]) for(let c in DB[k]) flatDB.push({code:c,name:DB[k][c][0],price:DB[k][c][1]}); }); 
        document.getElementById('st-db').innerText=fmt(flatDB.length)+"ê±´"; 
        refreshSetCodes(); 
        const files=await listSetFiles(); 
        const ss=document.getElementById('setFileSel'); 
        if(ss){ 
            if(!files.length){ ss.innerHTML='<option value="">set*.json ì—†ìŒ</option>'; document.getElementById('setFileStatus').innerText="-"; }
            else{ 
                const nm=files.slice().sort((a,b)=>{ const al=a.toLowerCase(),bl=b.toLowerCase(); if(al==="set_databaset.json")return -1; if(bl==="set_databaset.json")return 1; return al.localeCompare(bl); }); 
                let html=""; nm.forEach(f=>html+=`<option value="${f}">${setFileDisplayName(f)}</option>`); ss.innerHTML=html; 
                ss.value=nm.find(f=>f.toLowerCase()==="set_databaset.json"||f.toLowerCase()==="ì‹ ê²½ì°¨ë‹¨ìˆ  ì¡°í•©.json")||nm[0]; 
                await changeSetFile(); 
            } 
        } 
    }catch(e){console.error(e);} }

    function getFeePrice(c){ if(DB.fee&&DB.fee[c])return DB.fee[c][1]; if(DB.fee){ const k=Object.keys(DB.fee).find(x=>x.startsWith(c)); if(k)return DB.fee[k][1]; } return 0; }
    function setTarget(v){ document.getElementById('tAmt').value=v; autoBalance(); }
    function changeSet(){ 
        const tbody = document.getElementById('itemList');
        tbody.innerHTML = '';
        renderBlockAdjuster(); 
        const k=document.getElementById('setSel').value; if(!k)return; 
        setConsult('follow'); 
        let s=DB.sets[k]; s=normalizeSet(s); DB.sets[k]=s; 
        document.getElementById('dataView').style.display='block'; 
        document.getElementById('ccContent').innerHTML=(s.cc&&s.cc.length)?s.cc.join('<br>'):"ë“±ë¡ëœ ì¦ìƒ ì—†ìŒ"; 
        const sw=document.getElementById('ccSwitch'); document.getElementById('ccContent').style.display=sw.checked?'block':'none'; 
        renderItems(); 
    }
    function setConsult(t){ currentConsult=t; document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); computeSetMeta(); refreshSetCodes(); renderItems(); }
    function toggleCC(){ const b=document.getElementById('ccContent'); const s=document.getElementById('ccSwitch'); b.style.display=s.checked?'block':'none'; }
    function searchSets(v,e){ activeInputEl=e; const l=document.getElementById('globalSearchLayer'); if(!v||v.length<1){l.style.display='none';return;} computeSetMeta(); const r=e.getBoundingClientRect(); l.style.top=(r.bottom+window.scrollY+5)+'px'; l.style.left=(r.left+window.scrollX)+'px'; l.style.width=Math.max(300,r.width)+'px'; const q=v.toUpperCase(); let k=Object.keys(DB.sets || {}); if(INJ_ONLY)k=k.filter(x=>SET_META[x]&&SET_META[x].isInj); const f=k.filter(x=>SET_META[x]?.search.includes(q)).slice(0,40); l.innerHTML=f.map(x=>`<div class="search-item" onclick="selectSetFromSearch('${x}')"><span style="color:#0052cc; font-weight:900;">${SET_META[x]?.label||""}</span></div>`).join(''); l.style.display=f.length?'block':'none'; }
    function selectSetFromSearch(k){ document.getElementById('setSel').value=k; document.getElementById('setSearchInput').value=''; clearSearch(); changeSet(); }
    function searchLive(v,m,e){ activeInputEl=e; const l=document.getElementById('globalSearchLayer'); if(!v||v.length<2){l.style.display='none';return;} const r=e.getBoundingClientRect(); l.style.top=(r.bottom+window.scrollY+5)+'px'; l.style.left=(r.left+window.scrollX)+'px'; l.style.width=Math.max(300,r.width)+'px'; const f=flatDB.filter(i=>i.code.includes(v.toUpperCase())||i.name.includes(v)).slice(0,30); l.innerHTML=f.map(i=>`<div class="search-item" onclick="selectItem('${i.code}','${i.name.replace(/'/g,"\\'")}','${i.price}','${m}')"><span style="color:#0052cc;font-weight:800;">${i.code}</span><span style="flex:1;margin:0 10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${i.name}</span><b>${fmt(i.price)}</b></div>`).join(''); l.style.display=f.length?'block':'none'; }
    function selectItem(c,n,p,m){ const l=document.getElementById('globalSearchLayer'); if(m==='main')addSearchedItem(c,n,p); else if(m==='cell'&&activeInputEl){ const tr=activeInputEl.closest('tr'); const ci=tr.querySelector('.box-input.code-type'); ci.value=c; updateRowByCode(ci,tr.dataset.custom==='true',tr.dataset.idx); } l.style.display='none'; activeInputEl=null; }
    function clearSearch(){ document.getElementById('globalSearchLayer').style.display='none'; }
    function closeSearch(e){ if(!e.target.closest('#searchBox')&&!e.target.closest('.input-wrapper')&&!e.target.closest('.set-selector-group')&&!e.target.closest('.search-dropdown')) clearSearch(); }
    function addSearchedItem(c,n,p){ let fp=p; if(STRATEGY_DRUGS.some(d=>n.includes(d)))fp=100000; currentCustomItems.push({code:c,name:n,price:fp,q:1,nb:false,lock:false,isManual:false}); clearSearch(); document.getElementById('searchInput').value=''; renderItems(); }
    function addManualItem(){ currentCustomItems.push({code:"ETC",name:"ì„ì˜ í•­ëª©",price:0,q:1,nb:false,lock:false,isManual:true}); renderItems(); }
    function renderItems(){ const t=document.getElementById('itemList'); t.innerHTML=''; renderBlockAdjuster(); const k=document.getElementById('setSel').value; if(!k)return; let s=DB.sets[k]; s=normalizeSet(s); DB.sets[k]=s; const dgl=s.dg||[]; const dgs=document.getElementById('diagSection'); const dgt=document.getElementById('diagList'); dgt.innerHTML=''; if(dgl.length>0){ dgs.style.display='block'; dgl.forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="diag-code">${d.c}</td><td>${d.n}</td>`; dgt.appendChild(tr); }); }else{ dgs.style.display='none'; } if(currentConsult!=="none"){ const cc=(currentConsult==='first')?"AA154":"AA254"; const dp=getFeePrice(cc); const p=dp||CONSULT_PRICES[currentConsult]||0; const dn=(DB.fee&&DB.fee[cc]&&DB.fee[cc][0])?DB.fee[cc][0]:null; const n=dn||((currentConsult==='first')?"ì§„ì°°ë£Œ(ì´ˆì§„)":"ì§„ì°°ë£Œ(ì¬ì§„)"); const u=dp?cc:"CONST"; addRow(t,u,n,p,1,false,true,false); } s.it.forEach(i=>{ const c=i.c.toUpperCase(); if(deletedSetItems.has(c))return; if(carryOverItems.has(c)){ const v=carryOverItems.get(c); addRow(t,c,v.name,v.price,v.q,v.nb,v.lock,true); }else{ const info=DB.fee[c]||DB.drug[c]||DB.mat[c]||null; let n=info?info[0]:(i.n||c); let p=info?info[1]:0; if(STRATEGY_DRUGS.some(d=>n.includes(d)))p=100000; addRow(t,c,n,p,i.q,i.nb,!i.nb||c.includes('SONO')||c.includes('C-ARM'),false); } }); currentCustomItems.forEach((i,x)=>{ if(carryOverItems.has(i.code))return; if(i.isDeleted)return; addRow(t,i.code,i.name,i.price,i.q,i.nb,i.lock,false,true,x); }); carryOverItems.forEach((v,c)=>{ const e=Array.from(t.rows).some(r=>r.cells[0].innerText===c); if(!e) addRow(t,c,v.name,v.price,v.q,v.nb,v.lock,true); }); autoBalance(); renderBlockAdjuster(); }
    function addRow(t,c,n,p,q,nb,lk,cy,isC=false,idx=null){ const tr=document.createElement('tr'); tr.dataset.type=nb?'nb':'b'; tr.dataset.code=c; if(isC){tr.dataset.custom='true';tr.dataset.idx=idx;} let nh=`<div class="input-wrapper"><input class="box-input" value="${n}" oninput="searchLive(this.value,'cell',this)" onfocus="searchLive(this.value,'cell',this)">`; if(CONTRAST_REQUIRED_CODES.includes(c)||c.startsWith('HA')) nh+=`<span class="badge badge-req">ì¡°ì˜í•„ìš”</span>`; if(CONTRAST_KEYWORDS.some(k=>n.toUpperCase().includes(k))) nh+=`<span class="badge badge-con">ì¡°ì˜ì œ</span>`; nh+=`</div><div class="audit-msg" style="color:var(--accent);font-size:11px;font-weight:800;margin-top:2px;"></div>`; const b=`<button class="type-btn ${nb?'type-nb':'type-b'}" onclick="toggleType(this,'${c}',${isC},${idx})">${nb?'ë¹„ê¸‰ì—¬':'ê¸‰ì—¬'}</button>`; tr.innerHTML=`<td><div class="input-wrapper"><input class="box-input code-type" value="${c}" onchange="updateRowByCode(this,${isC},${idx})" oninput="searchLive(this.value,'cell',this)"></div></td><td>${nh}</td><td><input class="box-input-num p-input" value="${fmt(p)}" oninput="syncRow(this,'${c}',${isC},${idx})"></td><td><input class="box-input-num q-input" type="number" value="${q}" step="0.1" oninput="syncRow(this,'${c}',${isC},${idx})"></td><td>${b}</td><td><button class="carry-btn ${cy?'active':''}" onclick="toggleCarry(this,'${c}')">ğŸ“Œ</button></td><td><button class="del-btn" onclick="deleteRow(this,'${c}',${isC},${idx})">ğŸ—‘ï¸</button></td>`; t.appendChild(tr); }
    function updateRowByCode(i,isC,idx){ const nc=i.value.toUpperCase(); const tr=i.closest('tr'); const f=flatDB.find(x=>x.code===nc); if(f){ tr.querySelector('.box-input:not(.code-type)').value=f.name; tr.querySelector('.p-input').value=fmt(f.price); tr.dataset.code=nc; if(isC&&idx!==null){ currentCustomItems[idx].code=nc; currentCustomItems[idx].name=f.name; currentCustomItems[idx].price=f.price; } } autoBalance(); renderBlockAdjuster(); }
    function toggleType(b,c,isC,idx){ const tr=b.closest('tr'); const n=b.innerText==='ê¸‰ì—¬'; b.innerText=n?'ë¹„ê¸‰ì—¬':'ê¸‰ì—¬'; b.className=`type-btn ${n?'type-nb':'type-b'}`; tr.dataset.type=n?'nb':'b'; if(carryOverItems.has(c))carryOverItems.get(c).nb=n; if(isC&&idx!==null)currentCustomItems[idx].nb=n; autoBalance(); }
    function deleteRow(b,c,isC,idx){ if(carryOverItems.has(c))carryOverItems.delete(c); if(isC&&idx!==null){ currentCustomItems.splice(idx,1); }else{ deletedSetItems.add(c); } renderItems(); }
    function syncRow(e,c,isC,idx){ const tr=e.closest('tr'); const p=clean(tr.querySelector('.p-input').value); const q=parseFloat(tr.querySelector('.q-input').value)||0; if(carryOverItems.has(c)){ const v=carryOverItems.get(c); v.price=p; v.q=q; } if(isC&&idx!==null){ currentCustomItems[idx].price=p; currentCustomItems[idx].q=q; } if(e.classList.contains('p-input'))e.value=fmt(p); autoBalance(); }
    function toggleCarry(b,c){ const tr=b.closest('tr'); b.classList.toggle('active'); const cc=tr.querySelector('.box-input.code-type').value; if(b.classList.contains('active')){ carryOverItems.set(cc,{name:tr.querySelector('.box-input:not(.code-type)').value, price:clean(tr.querySelector('.p-input').value), q:parseFloat(tr.querySelector('.q-input').value)||0, nb:tr.dataset.type==='nb', lock:false}); }else{ carryOverItems.delete(c); } }
    function calc(){ let b=0,n=0,ls=0; let hc=false; let nc=null; document.querySelectorAll('#itemList tr').forEach(r=>{ const nm=r.querySelector('.box-input:not(.code-type)').value.toUpperCase(); if(CONTRAST_KEYWORDS.some(k=>nm.includes(k)))hc=true; }); document.querySelectorAll('#itemList tr').forEach(r=>{ const c=r.querySelector('.box-input.code-type').value.toUpperCase(); const p=clean(r.querySelector('.p-input').value); const q=parseFloat(r.querySelector('.q-input').value)||0; const m=r.querySelector('.audit-msg'); m.innerText=""; if(c.startsWith('LA')){ ls+=q; if(c==='LA357'&&q>1.5)m.innerText="âš ï¸ LA357 1.5 ì´ˆê³¼"; } if(CONTRAST_REQUIRED_CODES.includes(c)&&!hc)nc=c; if(r.dataset.type==='b')b+=(p*q); else n+=(p*q); }); const ab=document.getElementById('mainAlertBox'); let al=[]; if(ls>3.0)al.push("âš ï¸ ì°¨ë‹¨ìˆ  ì´ í•©ê³„ê°€ 3.0ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (ì‚­ê° ì£¼ì˜)"); if(nc)al.push("âš ï¸ ì¡°ì˜ì œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (í•„ìˆ˜ ì‹œìˆ  í¬í•¨ë¨)"); if(al.length>0){ ab.innerHTML=al.join("<br>"); ab.style.display="block"; ab.className=ls>3.0?"alert-box alert-red":"alert-box alert-orange"; }else{ ab.style.display="none"; } const bp=Math.floor(Math.floor(b*0.3)/10)*10; return {totalFull:Math.floor(b+n),bPay:bp,nbSum:Math.floor(n),finalPay:Math.floor((bp+n)/10)*10}; }
    function autoBalance(){ const t=clean(document.getElementById('tAmt').value); const rs=calc(); const rows=Array.from(document.querySelectorAll('#itemList tr')); let tr=rows.find(r=>r.dataset.type==='nb'&&STRATEGY_DRUGS.some(d=>r.querySelector('.box-input:not(.code-type)').value.includes(d))); if(!tr){ const rr=[...rows].reverse(); tr=rr.find(r=>r.dataset.type==='nb'); } if(tr){ const an=tr.querySelector('.box-input:not(.code-type)').value; document.getElementById('matrixAdjustName').innerText=`[ì¡°ì •: ${an}]`; let on=0; rows.forEach(r=>{ if(r!==tr&&r.dataset.type==='nb')on+=clean(r.querySelector('.p-input').value)*(parseFloat(r.querySelector('.q-input').value)||0); }); const pa=clean(tr.querySelector('.p-input').value); if(pa>0){ tr.querySelector('.q-input').value=((t-rs.bPay-on)/pa).toFixed(4); let mh=''; const bt=t%10000; const sp=Math.max(0,Math.floor(t/10000)*10000-50000); const ep=Math.floor(t/10000)*10000+20000; for(let i=sp;i<=ep;i+=10000){ const pt=i+bt; const qp=((pt-rs.bPay-on)/pa).toFixed(4); if(qp>=0){ const bs=(pt===t)?"background:#eef6ff; border-color:var(--blue);":""; mh+=`<div class="matrix-row" onclick="setTarget(${pt})" style="${bs}"><span class="matrix-target">${fmt(pt)}ì›</span><span class="matrix-val">ìˆ˜ëŸ‰ ${qp}</span></div>`; } } document.getElementById('matrixTable').innerHTML=mh; } } const f=calc(); document.getElementById('totalFull').innerText=fmt(f.totalFull); document.getElementById('summaryBenefit').innerText=fmt(f.bPay); document.getElementById('summaryNonBenefit').innerText=fmt(f.nbSum); document.getElementById('finalPay').innerText=fmt(f.finalPay); }
    window.onload=init;
    function getLArows(){ return Array.from(document.querySelectorAll('#itemList tr')).filter(r=>{ const c=(r.dataset.code||'').toUpperCase(); const i=r.querySelector('.box-input.code-type').value.toUpperCase(); return c.startsWith('LA')||i.startsWith('LA'); }); }
    function renderBlockAdjuster(){ const l=getLArows(); const c=l.length; const dc=Math.max(3,c); let h='<div class="section-title" style="border-left-color: var(--blue);">ì°¨ë‹¨ìˆ  ìˆ˜ëŸ‰ ì¡°ì •</div>'; for(let i=0;i<dc;i++){ const e=(i<c); let lb=`${i+1}ì°¨ë‹¨ìˆ `; let nm=""; let dis=""; if(e){ const tr=l[i]; const rn=tr.querySelector('.box-input:not(.code-type)').value; nm=`(${rn})`; }else{ nm=`<span style="color:#aaa;font-weight:normal;">(ì—†ìŒ)</span>`; dis="disabled style='opacity:0.3;cursor:default;'"; } h+=`<div class="block-adjust-row"><div class="block-adjust-label" title="${nm.replace(/<[^>]*>/g,'')}">${lb} <span style="font-size:0.9em;margin-left:4px;">${nm}</span></div><div class="block-adjust-ctrl"><button class="block-btn" ${dis} onclick="adjustBlockByIndex(${i},-1)">âˆ’</button><input id="blockStep_${i}" class="block-step" type="number" value="0.25" step="0.05" ${dis}><button class="block-btn" ${dis} onclick="adjustBlockByIndex(${i},+1)">ï¼‹</button></div></div>`; } document.getElementById('blockAdjustWrap').innerHTML=h; }
    function adjustBlockByIndex(i,d){ const l=getLArows(); if(!l[i])return; const tr=l[i]; const c=(tr.dataset.code||'').toUpperCase(); const iv=tr.querySelector('.box-input.code-type').value.toUpperCase(); if(!c.startsWith('LA')&&!iv.startsWith('LA')) return; const se=document.getElementById(`blockStep_${i}`); const s=se?(parseFloat(se.value)||0):0; if(!s)return; const qe=tr.querySelector('.q-input'); if(!qe)return; const cur=parseFloat(qe.value)||0; let n=cur+(d*s); if(n<0)n=0; n=Math.round(n*100)/100; qe.value=n.toFixed(2).replace(/\.00$/,'\.0').replace(/(\.\d)0$/,'$1'); const isc=tr.dataset.custom==='true'; const idx=isc?parseInt(tr.dataset.idx,10):null; try{ syncRow(qe,c||iv,isc,idx); }catch(e){} }
</script>
</body>
</html>
